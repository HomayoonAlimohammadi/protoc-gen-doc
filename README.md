# Divar Widgets Document Generator/Validator

- [Divar Widgets Document Generator/Validator](#divar-widgets-document-generatorvalidator)
  - [Maintainers](#maintainers)
  - [Introduction](#introduction)
  - [How to Use it as a Protoc Plugin?](#how-to-use-it-as-a-protoc-plugin)
  - [How Does it work?](#how-does-it-work)


## Maintainers

- @imannamdari
- @homayoon.alimohammadi

## Introduction

Divar Widgets Document Generator, as its name describes, generates documents for divar widgets by scanning [widgets](https://git.cafebazaar.ir/divar/divar_interface/-/blob/master/src/proto/divar_interface/widgets/widgets.proto) and [widgets_data](https://git.cafebazaar.ir/divar/divar_interface/-/blob/master/src/proto/divar_interface/widgets/widgets_data.proto). 

At the end you will be left with an autogenerated `widget-documentation.md` that houses the proper documentation for each widget and its corresponding fields. 

## How to Use it as a Protoc Plugin?

For this protoc plugin to work, its binary should be generated and placed somewhere inside `$PATH`.
```bash
go build -o $GOPATH/bin/protoc-gen-divar-doc ./cmd/protoc-gen-divar-doc/...
```

After doing so, this plugin will be registered and can be used with the normal `protoc` cli.
- Considering there is a widgets.proto and widgets_data.proto is available in the current directory
```bash
protoc --divar-doc_out=. widgets.proto widgets_data.proto
```

Extracting `widgets_data` can be tricky. There is also an `exclude` option to manually exclude any widget
from `fields doc` validation. 
`NOTICE`: This is only for validation. If fields doc are available, they won't be discarded and will be included in the final markdown file as normal. But if not, no errors will be thrown.
```bash
protoc --divar-doc_out=. --divar-doc_opt=exclude=SELECTOR_ROW widgets.proto widgets_data.proto
```
- Names of the widgets for this option should `exactly` match ones in `widgets.proto` Type enum. Just like the example above for `SELECTOR_ROW`
- There is also an `__ALL__` option available to exclude all widgets from being verified.


## How Does it work?

Generated documentations are based on `leading` comments in `widgets.proto` and `widgets_data.proto`. 
These comments should comply to a certain format. An example of a valid documentation is as below.

- widgets.proto
```proto
message Widget {
    enum Type {
        /* 
        * @support: android(8000-8080), ios(8000-8080), web
        * @design: https://figmaDesignUrl.com
        * @widgetify: https://widgetifyUrl.com
        */ 
        SELECTOR_ROW = 1;
    }
}
```

- widgets_data.proto
```proto
message SelectorRowData {

    // @support: android(8000-8080), ios(8000-8080), web
    string title = 1;

    // @support: android(8000-8080), ios(8000-8080), web
    string image_url = 2;  

    // @support: android(8000-8080), ios(8000-8080), web
    Action action = 3;

    // @support: android(8000-8080), ios(8000-8080), web
    bool has_divider = 5;

    // @support: android(8000-8080), ios(8000-8080), web
    bool has_notification = 6;

    // @support: android(8000-8080), ios(8000-8080), web
    base.Icon icon = 7;

    // @support: android(8000-8080), ios(8000-8080), web
    string notification_text = 8;

    // @support: android(8000-8080), ios(8000-8080), web
    string description = 9;

    // @support: android(8000-8080), ios(8000-8080), web
    bool has_arrow = 10;

    // @support: android(8000-8080), ios(8000-8080), web
    bool small = 11; 
}
```

Let's just call any word that starts with `@` a `CMD`. CMDs are validated in the process of creating the documentation markdown file and should be formatted correctly.
- `@support`
  - defines the supported `apiVersion` for android and ios and whether or not web supports this field/widget.
  - The structure of this CMD is as follows:
    ```proto
    // @support: android({from}-{until}), ios({from}-{until}), web
    ```
  - Some examples of a `CORRECT` support are:
    ```proto
    // @support: android(8000-) ---> android version 8000 until now is supported, ios and web are not
    // @support: web ---> only web is supported
    // @support android(8000-), ios(8000-) ---> android and ios supports this from the 8000 until now
    ```
  - Some examples of an `INCORRECT` support are:
    ```proto
    // @support: android() ---> invalid version range
    // @support android(8000-) ---> forgot ":"
    // support: android(8000-) ---> forgot "@"
    // @support: android(-) ---> {from} can not be ignored
    // @support: android(8000-8080) ios(8000-8080) web ---> platforms should be comma-separated (forgot ",")
    ```
- `@design`
  - A valid url that leads to the widget `figma` design page
- `@widgetify`
  - A valid url that leads to the `widgetify` page

`NOTICE`: Each `individual widget` should contain `all` the CMDs above. a `widget field` on the other hand need only to have `@support` CMD written properly.
